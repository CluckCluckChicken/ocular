<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ocular</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="icon" href="assets/icon.svg">
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
</head>

<body>
    <div class="bigheader">
        <div class="box-head">
            <h1 class='margined'><a href="/"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 24 24" class='icon'>
                        <path
                            d="M9.145 18.29c-5.042 0-9.145-4.102-9.145-9.145s4.103-9.145 9.145-9.145 9.145 4.103 9.145 9.145-4.102 9.145-9.145 9.145zm0-15.167c-3.321 0-6.022 2.702-6.022 6.022s2.702 6.022 6.022 6.022 6.023-2.702 6.023-6.022-2.702-6.022-6.023-6.022zm9.263 12.443c-.817 1.176-1.852 2.188-3.046 2.981l5.452 5.453 3.014-3.013-5.42-5.421z" />
                    </svg> ocular</a> <span class="bread">/</span> <a href='/stats.html'>stats</a></h1>
            <p class='margined'><a href='https://github.com/JeffaloBob/ocular' class="header-link">feedback</a> | <a
                    href='https://scratchdb.lefty.one' class="header-link">api and data from datonelefty</a></p>
        </div>
    </div>

    <div class="margined">
        <h1>stats</h1>
        <form method="get">
            <input required="" name="user" type="text" placeholder="user" id="searchbox" class="sb">
            <button type="submit" class="sbb">go</button>
        </form>
        <br>
        <div id='vue' v-cloak>
            <div v-if="loading">loading...</div> <!-- for some reason if i uncomment this line there suddenly are a bunch of errors and it litteraly makes no sense edit maybe not -->
            <div id="data" v-if="!splash">
                <img class='pfp' height='30px'
                    v-bind:src="'https://cdn2.scratch.mit.edu/get_image/user/'+user.id+'_60x60.png'">
                <h1 style="display: inline-block;">{{ user.name }}</h1> <i>{{ user.status }}</i>
                <div><b>{{ user.stats.posts }}</b> posts | <b>{{ user.stats.rank }}</b> worldwide</div>
                <div>first post: <b v-bind:title='user.stats.first.raw'>{{ user.stats.first.formatted }} </b> | latest
                    post: <b v-bind:title='user.stats.latest.raw'>{{ user.stats.latest.formatted }}</b></div>
                <!-- todo: add some kind of way to go to these posts -->

                <br>

                <canvas id="chart1" width="400" height="100"></canvas>
            </div>
            <div v-if="splash && !loading">
                this is forum stats, its based off of <a href='http://shefwerld.github.io/post/'>shefwerld stats</a> and currently can't do as much. <br>
                <br>soon it's going to be super cool hopefully
            </div>

        </div>

    </div>

</body>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get('user');

    var vue = new Vue({
        el: '#vue',
        data: {
            user: {
                name: 'Jeffalo',
                id: 420,
                status: '',
                stats: {
                    posts: 1005,
                    rank: ordinalSuffix(565),
                    counts: {
                        categories: [],
                        counts: []
                    },
                    first: {
                        raw: 'iso date or something',
                        formatted: 'June 19, 2018'
                    },
                    latest: {
                        raw: 'iso date or something',
                        formatted: 'June 19, 2018'
                    }
                }
            },
            splash: true,
            loading: false
        },
        methods: {
            chart: function () {
                var canvas= document.getElementById('chart1')
                if(!canvas) return
                var ctx = canvas.getContext('2d');
                
                var chart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: this.user.stats.counts.categories,
                        datasets: [{
                            label: '# of Votes',
                            data: this.user.stats.counts.counts,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.2)',
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(255, 206, 86, 0.2)',
                                'rgba(75, 192, 192, 0.2)',
                                'rgba(153, 102, 255, 0.2)',
                                'rgba(255, 159, 64, 0.2)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        title: {
                            display: true,
                            text: 'Post Distribution'
                        }
                    }
                });
            }
        },
        updated: function () {
            this.chart() //is this the best way to do this?
        }
    })
    if (username) {
        vue.loading = true
        fetch('https://scratchdb.lefty.one/v2/forum/user/info/'+username)
            .then(res => res.json())
            .then(forumdata => {
                fetch('https://scratchdb.lefty.one/v2/user/info/'+username)
                    .then(res1 => res1.json())
                    .then(userdata => { //callback heck moment
                        console.log(forumdata, userdata)
                        vue.user.name = userdata.username
                        vue.user.id = userdata.id

                        vue.user.stats.posts = forumdata.counts.total.count
                        vue.user.stats.rank = ordinalSuffix(forumdata.counts.total.rank)

                        vue.user.stats.first.raw = forumdata.firstPost.time.posted
                        vue.user.stats.first.formatted = formatDate(forumdata.firstPost.time.posted)

                        vue.user.stats.latest.raw = forumdata.lastPost.time.posted
                        vue.user.stats.latest.formatted = formatDate(forumdata.lastPost.time.posted)


                        //counts
                        var counts = []
                        var cats = []
                        Object.entries(forumdata.counts).forEach(i=>{
                            if(i[0] == 'total') return
                            counts.push(i[1].count)
                            cats.push(i[0])
                        })
                        console.log(counts)
                        vue.user.stats.counts.counts = counts
                        vue.user.stats.counts.categories = cats

                        vue.splash = false
                        vue.loading = false

/*                         fetch('https://games.jeffalo.net/status/'+userdata.username) //this is a WIP api but when it's done it will let people set custom statuses and fun
                        .then(res2=>res2.json())
                        .then(statusdata=>{
                            console.log(statusdata)
                            vue.user.status=statusdata.status
                        }) */
                    })

            })
    }


    //useful functions
    function ordinalSuffix(i) {
        var j = i % 10,
            k = i % 100;
        if (j == 1 && k != 11) {
            return i + "st";
        }
        if (j == 2 && k != 12) {
            return i + "nd";
        }
        if (j == 3 && k != 13) {
            return i + "rd";
        }
        return i + "th";
    }

    function formatDate(input) {
        const options = { weekday: 'short', year: 'numeric', month: 'long', day: 'numeric' };

        return new Date(input).toLocaleDateString('en-GB', options);
    }
</script>

</html>